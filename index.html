<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <title>Robotics Simulation with MORSE</title>


  <head>
    <meta charset="utf-8">

    <title>Robotics Simulation with MORSE</title>

    <meta name="description" content="A framework for easily simulating robots with Python and Blender">
    <meta name="author" content="Jeremy Nicola">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section data-background-video="media/videos/morse-1.0.webm">
          <h1>MORSE</h1>
          <h3>Robotics simulation with Blender and Python</h3>
          <p>
            <small>Presented by <a href="http://www.jeremy-nicola.info">Jeremy Nicola</a> / <a href="http://twitter.com/nicolaje">@nicolaje</a> / <a href="mailto:jeremy.nicola@gmail.com">Contact me</a></small>
          </p>
        </section>

        <section>
           <section>
           <h2>MORSE: Blender</h2>
           <p>
             Blender is a professional, open source 3D modeling, rendering and animation software.
           </p>
           <iframe data-autoplay width="420" height="345" src="https://www.youtube.com/embed/YE7VzlLtp-4"></iframe>
         </section>

          <section>
            <h2>MORSE: Blender Game Engine</h2>
            <video class="stretch" data-autoplay src="media/videos/bge-yofrankie.webm"></video>
          </section>
          <section>
            <h2>MORSE: Blender Game Engine</h2>
            <p>
              The BGE comes with Bullet, a powerful physics engine
            </p>
            <video class="stretch" data-autoplay src="media/videos/bullet.webm"></video>
          </section>
      </section>

        <section>
          <section>
            <h2>MORSE: components</h2>
            <h3>Environments</h3>
            <p>The environment is a Blender scene of the environment we want our tobots to evolve in.</p>
          </section>

          <section>
            <h2>MORSE: components</h2>
            <h3>Robots</h3>
            <p>A robot is a 3D model with some physical properties</p>
          </section>

          <section>
            <h2>MORSE: components</h2>
            <h3>Actuators</h3>
            <p>An actuator takes some inputs from the outside world (via a middleware -ros, moos...- for example)</br>
            and changes the behavior of the robot (modify its speed, its orientation...)</p>
          </section>

          <section>
            <h2>MORSE: components</h2>
            <h3>Sensors</h3>
            <p>A sensor gather data from the simulated world (distances, position, speed...) and communicate it to the outside world
            using a middleware</p>
          </section>

          <section>
            <h2>MORSE: components</h2>
            <h3>Zone</h3>
            <p>Defines a zone in the environment (not needed for our application)</p>
          </section>
        </section>

        <section>
          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>Creating a simulation workspace</h3>

            <pre>
              <code>
                :~$ morse create scout
              </code>
            </pre>
          </section>


          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>The builder script 1/2</h3>
            <p>The root of the simulation folder contains a default.py script...</p>
            <pre>
              <code>
                from morse.builder import *

                robot = Morsy()

                robot.translate(1.0, 0.0, 0.0)

                motion = MotionVW()
                robot.append(motion)

                # ...
              </code>
            </pre>
          </section>


          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>The builder script 2/2</h3>
            <pre>
              <code>
                # ...

                pose = Pose()
                robot.append(pose)

                robot.add_default_interface('socket')

                env = Environment('sandbox', fastmode = False)
                env.set_camera_location([10.0, -10.0, 10.0])
                env.set_camera_rotation([1.05, 0, 0.78])
              </code>
            </pre>
          </section>

          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <p>Launching the simulation</p>

            <pre>
              <code>
                :~$ morse run scout
              </code>
            </pre>
          </section>


          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <p>The simulation folder is self contained.</br>
            To use it on an other computer, just run:</p>
            <pre>
              <code>
                :~$ morse import /path/to/scout scout
              </code>
            </pre>
          </section>

          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>Creating your own robot 1/8</h3>
            <p>To add a robot in your simulation, you can use the following tool:</p>
            <pre>
              <code>
                :~$ morse add robot Boat scout
              </code>
            </pre>
          </section>

          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>Creating your own robot 2/8</h3>
            <p>The default 3D model is the MORSY robot, you can change that in the builder script associated with the robot</br>
            in scout/src/scout/builder/robots/Boat.py</p>
            <pre>
              <code>
                GroundRobot.__init__(self, 'scout/robots/Boat.blend', name)
              </code>
            </pre>
          </section>

          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>Creating your own robot 3/8</h3>
            <p>The robot has its own script created </br>
            in scout/src/scout/robots/Boat.py</br>
            It mainly contains a function that is called at every simulation frame.</p>
            <pre>
              <code>
                def default_action(self):
                    # Do some things
                    pass
              </code>
            </pre>
          </section>

          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>Creating your own robot 4/8</h3>
            <p>Since <a href="https://www.ensta-bretagne.fr/jaulin/mer2015_projet_start.pdf">in our project</a> we want to integrate the state equations ourself, we will do it here.</br>
            Let say the boat follows a circle of radius $r$ with a pulsation $\omega$:
          </p>
          \[
          \dot{x}= r*cos(\omega*t) \\
          \dot{y}= r*sin(\omega*t) \\
          \dot{z}= 0
          \]
          </section>

          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>Creating your own robot 5/8</h3>
            <pre>
              <code>
              _t = 0    # time ellapsed
              _r = 5    # radius of the circle
              _w = 2*pi # pulsation
              def default_action(self):
                  self._t = self._t + 1/self.frequency
                  dX = self._r*cos(self._w*self._t)/self.frequency
                  dY = self._r*sin(self._w*self._t)/self.frequency
                  dZ = 0
                  # Apply the translation
                  self.bge_object.applyMovement([dX, dY, dZ])
              </code>
            </pre>
          </section>

          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>Creating your own robot 6/8</h3>
            <p>Adding the following lines to the builder script:</p>
            <pre>
              <code>
                from scout.builder.robots import Boat
                # ...
                boat = Boat()
              </code>
            </pre>
          </section>

          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>Creating your own robot 7/8</h3>
            <p>Add some rotation</br>
            \[
            \dot{\psi}=\frac{\omega}{r} \\
            \dot{\theta}=0 \\
            \dot{\phi}=0
            \]
            </p>
            <pre>
              <code>
                # ...
                dPsi = self._w/self._r
                dTheta = 0
                dPhi = 0
                self.bge_object.applyRotation([dPhi, dTheta, dPsi])
              </code>
            </pre>
          </section>

          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>Creating your own robot 8/8</h3>
            <p>Tips from the robot class...</p>
            <pre>
              <code>
                # Accessing the robot position
                self.position_3d.x
                self.position_3d.y
                self.position_3d.z

                # Accessing the robot euler angles
                self.position_3d.yaw
                self.position_3d.pitch
                self.position_3d.roll
              </code>
            </pre>
          </section>

          <section>
            <h2>Anatomy of a MORSE simulation</h2>
            <h3>Creating your own actuator</h3>
            <pre>
              <code>
                :~$ morse add actuator BoatActuator scout
              </code>
            </pre>
          </section>
<section>
  <h2>Anatomy of a MORSE simulation</h2>
  <h3>Creating your own actuator</h3>
  <p>The logic of the actuator is in scout/src/scout/actuators/BoatActuator.py.
    The fields add_data defines the inputs of the actuator. This variables will be the only entry point for our middleware to control the actuator.
      MORSE has some mechanisms to make those values modifiable from outside the simulation (via sockets or Python for example).
  </p>
<pre>
  <code>
    add_data('r', 0, 'double', 'Radius of the circle')
    add_data('w', 0, 'double', 'Pulsation')
  </code>
</pre>
</section>
<section>
  <h2>Anatomy of a MORSE simulation</h2>
  <h3>Creating your own actuator</h3>
  <p>The method default_action is called at every simulation step.</p>
  <pre>
    <code>
      # At every simulation step, the radius and the pulsation will
      # be updated according to the values set from the outside
      def default_action(self):
          self.robot_parent._r=self.local_data['r']
          self.robot_parent._w=self.local_data['w']
    </code>
  </pre>
</section>

<section>
  <h2>Anatomy of a MORSE simulation</h2>
  <h3>Creating your own sensor</h3>
  <pre>
    <code>
      :~$ morse add sensor Distance scout
    </code>
  </pre>
  <p>This sensor will compute the distance between the current robot and all the robots in the scene</p>
</section>

<section>
  <h2>Anatomy of a MORSE simulation</h2>
  <h3>Creating your own sensor</h3>
  <p>In the same fashion than for the actuator, we define the variables that will be accessed from the outside world:</p>
  <pre>
    <code>
add_data('distances', {}, "dict",
'A robot_name / distance between this robot and the robot measured key / value pair in meters')
    </code>
  </pre>
</section>

<section>
  <h2>Anatomy of a MORSE simulation</h2>
  <h3>Creating your own sensor</h3>
  <p>The default_action is where the logic of the actuator goes</p>
  <pre>
    <code>
      def default_action(self):
        self.local_data['distances']={} # empty the dict
        parent = self.robot_parent.bge_object
        # Loop through all the objects in the scene
        for obj in blenderapi.scene().objects:
          # Skip distance to self
          if parent != obj:
            distance = self._measure_distance_to_object (parent, obj)
            self.local_data['distances'][obj.name] = distance
    </code>
  </pre>
</section>


        </section>

<section>
  <section>
    <h3>Talking to morse</h3>
    <h4>With MOOS 1/2</h4>
    <p>
      Morse provides mechanisms to interface your components with other middlewares.</br>
      You just have to provide a custom serialization/deserialization script when instantiating your sensor/actuator.
    </p>
    <pre>
      <code>
myDistanceSensor=Distance()
dist.add_stream('moos','scout.sensors.DistNotifier.DistNotifier',moos_port=9001)
      </code>
    </pre>
  </section>

  <section>
    <h3>Talking to morse</h3>
    <h4>With MOOS 2/2</h4>
    <p>
      Structure of a MOOS serializer for the Distance sensor </br>
      in scout/src/scout/sensors/DistNotifier.py
    </p>
    <pre>
      <code>
        import pymoos.MOOSCommClient
        from morse.middleware.moos import AbstractMOOS

        def default(self,  ci='unused'):
          cur_time=pymoos.MOOSCommClient.MOOSTime()
          # Go through all the ranges measured by the sensor
          for robotName, range in self.data['distances'].items():
            # Publish each of the in the MOOSDB
            self.m.Notify(str(robotName), double(range), cur_time)
      </code>
    </pre>
  </section>

  </section>
</section>
<section>
<section>
<h3>Exercices</h3>
<h4>Setting the project up</h4>
<ol>
  <li>Download the simulation from <a href="">http://github.com/nicolaje/morse-scout/</a></li>
  <li>Import the simulation using the morse import command</li>
  <li>Verify that it runs</li>
</ol>
</section>

<section>
<h3>Exercices</h3>
<h4>Integrate your own state equations 1/3</h4>
<ol>
  <li>Open scout/src/scout/robots/Boat.py</a></li>
  <li>Integrate the state equations for the boat:</li>
  \[
  \dot{x} = v*cos(\psi) \\
  \dot{y} = v*sin(\psi) \\
  \dot{v} = 0.01*(u_1-v^2) \\
  \dot{\psi} = 0.01*v*u_2
  \]
</ol>
<p>Tip: $v,u_1,u_2$ are stored in self._v, self._u1, self._u2</p>
</section>

<section>
<h3>Exercices</h3>
<h4>Integrate your own state equations 2/3</h4>
<ol>
  <li>Open scout/src/scout/robots/Scout.py</a></li>
  <li>Integrate the state equations for the scout:</li>
  \[
  \dot{x} = v*cos(\theta)*cos(\psi) \\
  \dot{y} = v*cos(\theta)*sin(\psi) \\
  \dot{z} = -v*sin(\theta) \\
  \dot{v} = u_1 - 0.1*v^2\\
  \dots
  \]
</ol>
</section>



<section>
<h3>Exercices</h3>
<h4>Integrate your own state equations 3/3</h4>
\[
\dots\\
\dot{\psi} = \frac{sin(\psi)}{cos(\theta)}*v*u_2+\frac{cos(\phi)}{cos(\theta)}*v*u_3\\
\dot{\theta} = cos(\phi)*v*u_2-sin(\phi)*v*u_3\\
\dot{\phi} = -0.1*sin(\phi)+tan(\theta)*v*(sin(\phi)*u_2+cos(\phi)*u_3)
\]
<p>Tip: $v,u_1,u_2,u_3$ are stored in self._v, self._u1, self._u2, self._u3</p>
</section>



<section>
  <h3>Exercices</h3>
  <h4>Implement your own actuator 1/2</h4>
  <ol>
    <li>Open scout/src/scout/actuators/BoatActuator.py</li>
    <li>Apply (copy) the values of local_data['u1'] and local_data['u2'] to the boat (_u1, _u2)</li>
  </ol>
  <p>Tip: the boat (the robot whose this actuator is attached to) is stored as self.robot_parent</p>
</section>

<section>
  <h3>Exercices</h3>
  <h4>Implement your own actuator 2/2</h4>
  <ol>
    <li>Open scout/src/scout/actuators/ScoutActuator.py</li>
    <li>Apply (copy) the values of local_data['u1'], local_data['u2'] and data['u3'] to the scout (_u1, _u2, _u3)</li>
  </ol>
  <p>Tip: the scout (the robot whose this actuator is attached to) is stored as self.robot_parent</p>
</section>

<section>
  <h3>Test your work</h3>
  <ol>
    <li>Run a MOOSDB per robot (i.e.: per port, or community)</a></li>
    <li>Publish values for u1, u2...:</li>
  </ol>
  <pre>
    <code>
      # Make the boat turn in circle
      uPokeDB u1=1 u2=0.5 host=localhost port=9000
      # Make the scout 1 dive
      uPokeDB u1=0.1 u2=0.1 host=localhost port=9001
      # Make the scout 2 turn in circle
      uPokeDB u1=0.1 u3=0.1 host=localhost port=9002
    </code>
  </pre>
</section>


</section>
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

    // Full list of configuration options available at:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
      controls: true,
      progress: true,
      history: true,
      center: true,

      transition: 'slide', // none/fade/slide/convex/concave/zoom
math: {
        mathjax: 'http://cdn.mathjax.org/mathjax/latest/MathJax.js',
        config: 'TeX-AMS_HTML-full'  // See http://docs.mathjax.org/en/latest/config-files.html
    },
      // Optional reveal.js plugins
      dependencies: [
        { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
        { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
        { src: 'plugin/zoom-js/zoom.js', async: true },
        { src: 'plugin/notes/notes.js', async: true },
        { src: 'plugin/math/math.js', async: true }
      ]
    });

    </script>
  </body>
  </html>
